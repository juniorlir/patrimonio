<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Patrimônio - Comebom Distribuidora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #c8102e;
      --primary-dark: #940b21;
      --accent: #f4b000;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #333333;
      --muted: #777777;
      --border: #dddddd;
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
    }

    button {
      cursor: pointer;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .logo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .logo-header .brand {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
    }

    .logo-header .brand span {
      color: var(--accent);
    }

    .logo-header .user-info {
      font-size: 14px;
      color: var(--muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      padding: 16px;
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      overflow-x: auto;
    }

    .tab-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--primary);
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      color: var(--muted);
      font-weight: 500;
    }

    .field input,
    .field select,
    .field textarea {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 14px;
    }

    .field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }

    .btn-secondary {
      background: transparent;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 16px;
      font-size: 14px;
      color: var(--text);
    }

    .btn-danger {
      background: #d32f2f;
      color: #fff;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .filters input,
    .filters select {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    /* Tela de Login */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #ffe0e0, #f5f5f5);
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      padding: 24px 20px;
    }

    .login-title {
      text-align: center;
      margin-bottom: 16px;
    }

    .login-title h1 {
      font-size: 22px;
      margin-bottom: 4px;
      color: var(--primary);
    }

    .login-title p {
      font-size: 13px;
      color: var(--muted);
    }

    .login-tabs {
      display: flex;
      border-radius: 999px;
      background: #f1f1f1;
      padding: 3px;
      margin-bottom: 16px;
    }

    .login-tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 8px;
      font-size: 14px;
      background: transparent;
      cursor: pointer;
    }

    .login-tab-btn.active {
      background: #fff;
      font-weight: 600;
      color: var(--primary);
    }

    .login-footer {
      text-align: center;
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal de Detalhes */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: 18px;
    }

    .close-btn {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .status-ativo {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-baixado {
      background: #ffebee;
      color: #c62828;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .logo-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }
  </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="login-screen" class="login-wrapper">
  <div class="login-card">
    <div class="login-title">
      <div class="brand" style="font-size:26px;margin-bottom:4px;">
        COMEBOM <span>Distribuidora</span>
      </div>
      <p>Controle de Patrimônio em nuvem usando banco Supabase.</p>
    </div>

    <div class="login-tabs">
      <button id="tab-login" class="login-tab-btn active" type="button">Entrar</button>
      <button id="tab-register" class="login-tab-btn" type="button">Cadastrar</button>
    </div>

    <form id="login-form">
      <div class="field">
        <label for="login-email">E-mail</label>
        <input type="email" id="login-email" required>
      </div>
      <div class="field" style="margin-top:8px;">
        <label for="login-senha">Senha</label>
        <input type="password" id="login-senha" required>
      </div>
      <button type="submit" class="btn-primary" style="width:100%;margin-top:12px;">Entrar</button>
    </form>

    <form id="register-form" style="display:none;">
      <div class="field">
        <label for="reg-nome">Nome</label>
        <input type="text" id="reg-nome" required>
      </div>
      <div class="field" style="margin-top:8px;">
        <label for="reg-email">E-mail</label>
        <input type="email" id="reg-email" required>
      </div>
      <div class="field" style="margin-top:8px;">
        <label for="reg-senha">Senha</label>
        <input type="password" id="reg-senha" minlength="4" required>
      </div>
      <button type="submit" class="btn-primary" style="width:100%;margin-top:12px;">Criar conta e entrar</button>
    </form>

    <div class="login-footer">
      Duplo clique em um bem no inventário abre os detalhes e o termo de responsabilidade.
    </div>
  </div>
</div>

<!-- APLICAÇÃO PRINCIPAL -->
<div id="app-screen" style="display:none;">
  <div class="app-container">
    <div class="logo-header">
      <div class="brand">
        COMEBOM <span>Distribuidora</span>
      </div>
      <div class="user-info">
        <span id="user-name"></span> • <button id="btn-logout" class="btn-secondary" type="button">Sair</button>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-bens">Bens patrimoniais</button>
        <button class="tab-btn" data-tab="tab-inventario">Inventário físico</button>
        <button class="tab-btn" data-tab="tab-mov">Movimentações</button>
      </div>

      <!-- ABA BENS -->
      <div id="tab-bens" class="tab-content active">
        <h3>Cadastro de bens patrimoniais</h3>
        <p class="small">Preencha os dados do bem e clique em "Salvar bem". Para editar, clique em uma linha da tabela.</p>
        <div class="grid" style="margin-top:8px;">
          <div class="field">
            <label for="bem-id">ID (gerado automaticamente)</label>
            <input id="bem-id" type="text" readonly placeholder="Novo bem">
          </div>
          <div class="field">
            <label for="bem-descricao">Descrição</label>
            <input id="bem-descricao" type="text" required>
          <div class="field">
            <label for="bem-numserie">Nº de série</label>
            <input id="bem-numserie" type="text">
          </div>
          <div class="field">
            <label for="bem-tag">Tag / Patrimônio</label>
            <input id="bem-tag" type="text">
          </div>
          <div class="field">
            <label for="bem-setor">Setor</label>
            <input id="bem-setor" type="text">
          </div>
          <div class="field">
            <label for="bem-localizacao">Localização física</label>
            <input id="bem-localizacao" type="text">
          </div>
          <div class="field">
            <label for="bem-responsavel">Responsável atual</label>
            <input id="bem-responsavel" type="text">
          </div>
          <div class="field">
            <label for="bem-data-aq">Data de aquisição</label>
            <input id="bem-data-aq" type="date">
          </div>
          <div class="field">
            <label for="bem-vida-util">Vida útil (meses)</label>
            <input id="bem-vida-util" type="number" min="0">
          </div>
          <div class="field">
  <label for="bem-metodo">Método de depreciação</label>
  <select id="bem-metodo">
    <option value="">Selecione...</option>
    <option value="Linear">Linear</option>
    <option value="Soma dos dígitos">Soma dos dígitos</option>
    <option value="Unidades produzidas">Unidades produzidas</option>
    <option value="Saldo decrescente">Saldo decrescente</option>
    <option value="Não aplicável">Não aplicável</option>
  </select>
</div>

          <div class="field">
            <label for="bem-data-uso">Data início de uso</label>
            <input id="bem-data-uso" type="date">
          </div>
          <div class="field">
            <label for="bem-situacao">Situação</label>
            <select id="bem-situacao">
              <option value="Ativo">Ativo</option>
              <option value="Em manutenção">Em manutenção</option>
              <option value="Baixado">Baixado</option>
            </select>
          </div>
          <div class="field">
  <label for="bem-motivo-baixa">Motivo de baixa</label>
  <select id="bem-motivo-baixa">
    <option value="">Selecione...</option>
    <option value="Obsolescência">Obsolescência</option>
    <option value="Perda / Roubo">Perda / Roubo</option>
    <option value="Sucateamento">Sucateamento</option>
    <option value="Venda / Alienação">Venda / Alienação</option>
    <option value="Doação">Doação</option>
    <option value="Transferência para outra empresa">Transferência para outra empresa</option>
    <option value="Avaria irreparável">Avaria irreparável</option>
    <option value="Reclassificação contábil">Reclassificação contábil</option>
    <option value="Outro motivo">Outro motivo</option>
  </select>
</div>

          <div class="field" style="grid-column:1/-1;">
            <label for="bem-obs">Observações</label>
            <textarea id="bem-obs"></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="btn-salvar-bem" class="btn-primary" type="button">Salvar bem</button>
          <button id="btn-novo-bem" class="btn-secondary" type="button">Novo</button>
          <button id="btn-deletar-bem" class="btn-danger" type="button">Excluir bem</button>
        </div>

        <h4 style="margin-top:16px;">Bens cadastrados</h4>
        <div class="table-wrapper">
          <table id="tabela-bens">
            <thead>
            <tr>
              <th>ID</th>
              <th>Descrição</th>
              <th>Setor</th>
              <th>Responsável</th>
              <th>Tag</th>
              <th>Situação</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <p class="small">Duplo clique em uma linha para abrir os detalhes e o termo de responsabilidade.</p>
      </div>

      <!-- ABA INVENTÁRIO -->
      <div id="tab-inventario" class="tab-content">
        <h3>Inventário físico</h3>
        <div class="filters">
          <input type="text" id="filtro-desc" placeholder="Filtrar por descrição">
          <input type="text" id="filtro-setor" placeholder="Filtrar por setor">
          <input type="text" id="filtro-resp" placeholder="Filtrar por responsável">
        </div>
        <div class="table-wrapper">
          <table id="tabela-inventario">
            <thead>
            <tr>
              <th>ID</th>
              <th>Descrição</th>
              <th>Setor</th>
              <th>Localização</th>
              <th>Responsável</th>
              <th>Situação</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <p class="small">Duplo clique em um bem para ver os detalhes e o histórico de movimentações.</p>
      </div>

      <!-- ABA MOVIMENTAÇÕES -->
      <div id="tab-mov" class="tab-content">
        <h3>Movimentações de bens</h3>
        <div class="grid" style="margin-top:8px;">
          <div class="field">
            <label for="mov-bem">Bem</label>
            <select id="mov-bem"></select>
          </div>
          <div class="field">
            <label for="mov-data">Data da movimentação</label>
            <input type="date" id="mov-data">
          </div>
          <div class="field">
            <label for="mov-tipo">Tipo</label>
            <input type="text" id="mov-tipo" placeholder="Ex: Transferência de responsável">
          </div>
          <div class="field">
            <label for="mov-setor-origem">Setor origem</label>
            <input type="text" id="mov-setor-origem">
          </div>
          <div class="field">
            <label for="mov-setor-destino">Setor destino</label>
            <input type="text" id="mov-setor-destino">
          </div>
          <div class="field">
            <label for="mov-resp-origem">Responsável origem</label>
            <input type="text" id="mov-resp-origem">
          </div>
          <div class="field">
            <label for="mov-resp-destino">Responsável destino</label>
            <input type="text" id="mov-resp-destino">
          </div>
          <div class="field">
            <label for="mov-valor">Valor movimentado (opcional)</label>
            <input type="number" id="mov-valor" step="0.01">
          </div>
          <div class="field" style="grid-column:1/-1;">
            <label for="mov-desc">Descrição / observação</label>
            <textarea id="mov-desc"></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="btn-registrar-mov" class="btn-primary" type="button">Registrar movimentação</button>
        </div>

        <h4 style="margin-top:16px;">Últimas movimentações</h4>
        <div class="table-wrapper">
          <table id="tabela-mov">
            <thead>
            <tr>
              <th>Data</th>
              <th>ID Mov</th>
              <th>Bem</th>
              <th>Tipo</th>
              <th>Origem</th>
              <th>Destino</th>
              <th>Resp. origem</th>
              <th>Resp. destino</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETALHES BEM -->
<div id="modal-detalhes" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="det-titulo">Bem</h3>
      <button class="close-btn" type="button" onclick="fecharModal()">×</button>
    </div>
    <div id="det-body"></div>
    <h4 style="margin-top:12px;">Histórico de movimentações</h4>
    <div class="table-wrapper" style="max-height:220px;">
      <table id="tabela-hist">
        <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Setor origem</th>
          <th>Setor destino</th>
          <th>Resp. origem</th>
          <th>Resp. destino</th>
          <th>Descrição</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="actions" style="margin-top:12px;">
      <button id="btn-termo" class="btn-primary" type="button">Gerar termo de responsabilidade</button>
      <button class="btn-secondary" type="button" onclick="fecharModal()">Fechar</button>
    </div>
  </div>
</div>

<script>
  // ================== CONFIG SUPABASE ======================
  const SUPABASE_URL = "https://vjqjebogkebxioeqnmbn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_67cWgho9SpaO9IzZ0BDhyA_2qvQA53x"; // <-- TROCAR PELA SUA PUBLISHABLE / ANON KEY
    const supaHeaders = {
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer " + SUPABASE_KEY,
    "Content-Type": "application/json",
    "Prefer": "return=representation"
  };

  async function supaSelect(table, extraQuery) {
    const q = extraQuery ? extraQuery : "?select=*";
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}${q}`, {
      method: "GET",
      headers: supaHeaders
    });
    if (!resp.ok) {
      const err = await resp.text();
      throw new Error("Erro Supabase SELECT: " + err);
    }
    return resp.json();
  }

    async function supaInsert(table, data) {
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
      method: "POST",
      headers: supaHeaders,
      body: JSON.stringify(data)
    });
    if (!resp.ok) {
      const err = await resp.text();
      console.error("Erro Supabase INSERT:", err);
      throw new Error(err);
    }
    return resp.json();
  }

  async function supaUpdate(table, idColumn, idValue, data) {
    const query = `?select=*&${idColumn}=eq.${encodeURIComponent(idValue)}`;
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
      method: "PATCH",
      headers: supaHeaders,
      body: JSON.stringify(data)
    });
    if (!resp.ok) {
      const err = await resp.text();
      console.error("Erro Supabase UPDATE:", err);
      throw new Error(err);
    }
    return resp.json();
  }

  async function supaDelete(table, idColumn, idValue) {
    const query = `?${idColumn}=eq.${encodeURIComponent(idValue)}`;
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
      method: "DELETE",
      headers: supaHeaders
    });
    if (!resp.ok) {
      const err = await resp.text();
      console.error("Erro Supabase DELETE:", err);
      throw new Error(err);
    }
    return true;
  }


  // ================== ESTADO GLOBAL ====================
  let usuarioAtual = null;
  let bens = [];
  let movimentacoes = [];
  let bemSelecionadoId = null;
  let bemModalAtual = null;

  const loginScreen = document.getElementById("login-screen");
  const appScreen = document.getElementById("app-screen");

  // ================== LOGIN / CADASTRO =================

  document.getElementById("tab-login").addEventListener("click", () => {
    document.getElementById("tab-login").classList.add("active");
    document.getElementById("tab-register").classList.remove("active");
    document.getElementById("login-form").style.display = "block";
    document.getElementById("register-form").style.display = "none";
  });

  document.getElementById("tab-register").addEventListener("click", () => {
    document.getElementById("tab-register").classList.add("active");
    document.getElementById("tab-login").classList.remove("active");
    document.getElementById("login-form").style.display = "none";
    document.getElementById("register-form").style.display = "block";
  });

  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("login-email").value.trim();
    const senha = document.getElementById("login-senha").value.trim();
    try {
      const query = `?select=*&email=eq.${encodeURIComponent(email)}&senha=eq.${encodeURIComponent(senha)}`;
      const users = await supaSelect("usuarios", query);
      if (!users.length) {
        alert("Usuário ou senha inválidos.");
        return;
      }
      usuarioAtual = users[0];
      localStorage.setItem("usuarioPatrimonio", JSON.stringify(usuarioAtual));
      iniciarApp();
    } catch (err) {
      console.error(err);
      alert("Erro ao conectar com a API de login.");
    }
  });

  document.getElementById("register-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("reg-nome").value.trim();
    const email = document.getElementById("reg-email").value.trim();
    const senha = document.getElementById("reg-senha").value.trim();
    if (!nome || !email || !senha) {
      alert("Preencha nome, e-mail e senha.");
      return;
    }
    try {
      await supaInsert("usuarios", { nome, email, senha });
      const query = `?select=*&email=eq.${encodeURIComponent(email)}&senha=eq.${encodeURIComponent(senha)}`;
      const users = await supaSelect("usuarios", query);
      usuarioAtual = users[0];
      localStorage.setItem("usuarioPatrimonio", JSON.stringify(usuarioAtual));
      iniciarApp();
    } catch (err) {
      console.error(err);
      alert("Erro ao cadastrar usuário. Verifique se o e-mail já não está em uso.");
    }
  });

  document.getElementById("btn-logout").addEventListener("click", () => {
    localStorage.removeItem("usuarioPatrimonio");
    usuarioAtual = null;
    bens = [];
    movimentacoes = [];
    loginScreen.style.display = "flex";
    appScreen.style.display = "none";
  });

  function iniciarApp() {
    document.getElementById("user-name").textContent = usuarioAtual.nome || usuarioAtual.email;
    loginScreen.style.display = "none";
    appScreen.style.display = "block";
    carregarTudo();
  }

  async function carregarTudo() {
    try {
      bens = await supaSelect("bens");
      movimentacoes = await supaSelect("movimentacoes");
      renderBens();
      renderInventario();
      preencherSelectMov();
      renderTabelaMov();
    } catch (err) {
      console.error(err);
      alert("Erro ao carregar dados do servidor Supabase.");
    }
  }

  // ================== TABS =============================
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tabId = btn.getAttribute("data-tab");
      document.querySelectorAll(".tab-content").forEach(el => {
        el.classList.toggle("active", el.id === tabId);
      });
    });
  });

  // ================== BENS =============================

  function limparFormularioBem() {
    bemSelecionadoId = null;
    document.getElementById("bem-id").value = "";
    document.getElementById("bem-descricao").value = "";
    document.getElementById("bem-categoria").value = "";
    document.getElementById("bem-numserie").value = "";
    document.getElementById("bem-tag").value = "";
    document.getElementById("bem-setor").value = "";
    document.getElementById("bem-localizacao").value = "";
    document.getElementById("bem-responsavel").value = "";
    document.getElementById("bem-data-aq").value = "";
    document.getElementById("bem-vida-util").value = "";
    document.getElementById("bem-metodo").value = "";
    document.getElementById("bem-data-uso").value = "";
    document.getElementById("bem-situacao").value = "Ativo";
    document.getElementById("bem-motivo-baixa").value = "";
    document.getElementById("bem-obs").value = "";
  }

  document.getElementById("btn-novo-bem").addEventListener("click", limparFormularioBem);

  document.getElementById("btn-salvar-bem").addEventListener("click", async () => {
    const data = {
      descricao: document.getElementById("bem-descricao").value.trim(),
      categoria: document.getElementById("bem-categoria").value.trim(),
      numSerie: document.getElementById("bem-numserie").value.trim(),
      tag: document.getElementById("bem-tag").value.trim(),
      setor: document.getElementById("bem-setor").value.trim(),
      localizacao: document.getElementById("bem-localizacao").value.trim(),
      responsavel: document.getElementById("bem-responsavel").value.trim(),
      dataAquisicao: document.getElementById("bem-data-aq").value,
      valorAquisicao: "",
      vidaUtilMeses: document.getElementById("bem-vida-util").value,
      metodoDepreciacao: document.getElementById("bem-metodo").value.trim(),
      dataInicioUso: document.getElementById("bem-data-uso").value,
      situacao: document.getElementById("bem-situacao").value,
      motivoBaixa: document.getElementById("bem-motivo-baixa").value.trim(),
      obs: document.getElementById("bem-obs").value.trim(),
      criado_por: usuarioAtual ? usuarioAtual.email : ""
    };
    if (!data.descricao) {
      alert("Informe a descrição do bem.");
      return;
    }
    try {
      const idAtual = bemSelecionadoId;
      if (idAtual) {
        await supaUpdate("bens", "id", idAtual, data);
        alert("Bem atualizado com sucesso.");
      } else {
        const inserted = await supaInsert("bens", data);
        const novo = inserted && inserted[0];
        if (novo) {
          bemSelecionadoId = novo.id;
          document.getElementById("bem-id").value = novo.id;
        }
        alert("Bem cadastrado com sucesso.");
      }
      await carregarTudo();
      limparFormularioBem();
    } catch (err) {
      console.error(err);
      alert("Erro ao salvar bem no Supabase.");
    }
  });

  document.getElementById("btn-deletar-bem").addEventListener("click", async () => {
    if (!bemSelecionadoId) {
      alert("Selecione um bem na tabela para excluir.");
      return;
    }
    if (!confirm("Tem certeza que deseja excluir este bem?")) return;
    try {
      await supaDelete("bens", "id", bemSelecionadoId);
      alert("Bem excluído.");
      await carregarTudo();
      limparFormularioBem();
    } catch (err) {
      console.error(err);
      alert("Erro ao excluir bem no Supabase.");
    }
  });

  function renderBens() {
    const tbody = document.querySelector("#tabela-bens tbody");
    tbody.innerHTML = "";
    bens.forEach(b => {
      const tr = document.createElement("tr");
      tr.dataset.id = b.id;
      tr.innerHTML = `
        <td>${b.id || ""}</td>
        <td>${b.descricao || ""}</td>
        <td>${b.setor || ""}</td>
        <td>${b.responsavel || ""}</td>
        <td>${b.tag || ""}</td>
        <td>${b.situacao || ""}</td>
      `;
      tr.addEventListener("click", () => preencherFormularioBem(b));
      tr.addEventListener("dblclick", () => abrirModalDetalhes(b.id));
      tbody.appendChild(tr);
    });
  }

  function preencherFormularioBem(b) {
    bemSelecionadoId = b.id;
    document.getElementById("bem-id").value = b.id || "";
    document.getElementById("bem-descricao").value = b.descricao || "";
    document.getElementById("bem-categoria").value = b.categoria || "";
    document.getElementById("bem-numserie").value = b.numSerie || "";
    document.getElementById("bem-tag").value = b.tag || "";
    document.getElementById("bem-setor").value = b.setor || "";
    document.getElementById("bem-localizacao").value = b.localizacao || "";
    document.getElementById("bem-responsavel").value = b.responsavel || "";
    document.getElementById("bem-data-aq").value = b.dataAquisicao || "";
    document.getElementById("bem-vida-util").value = b.vidaUtilMeses || "";
    document.getElementById("bem-metodo").value = b.metodoDepreciacao || "";
    document.getElementById("bem-data-uso").value = b.dataInicioUso || "";
    document.getElementById("bem-situacao").value = b.situacao || "Ativo";
    document.getElementById("bem-motivo-baixa").value = b.motivoBaixa || "";
    document.getElementById("bem-obs").value = b.obs || "";
  }

  // ================== INVENTÁRIO =======================

  function renderInventario() {
    const tbody = document.querySelector("#tabela-inventario tbody");
    tbody.innerHTML = "";

    const filtroDesc = document.getElementById("filtro-desc").value.toLowerCase();
    const filtroSetor = document.getElementById("filtro-setor").value.toLowerCase();
    const filtroResp = document.getElementById("filtro-resp").value.toLowerCase();

    bens
      .filter(b =>
        (b.descricao || "").toLowerCase().includes(filtroDesc) &&
        (b.setor || "").toLowerCase().includes(filtroSetor) &&
        (b.responsavel || "").toLowerCase().includes(filtroResp)
      )
      .forEach(b => {
        const tr = document.createElement("tr");
        tr.dataset.id = b.id;
        tr.innerHTML = `
          <td>${b.id || ""}</td>
          <td>${b.descricao || ""}</td>
          <td>${b.setor || ""}</td>
          <td>${b.localizacao || ""}</td>
          <td>${b.responsavel || ""}</td>
          <td>${b.situacao || ""}</td>
        `;
        tr.addEventListener("dblclick", () => abrirModalDetalhes(b.id));
        tbody.appendChild(tr);
      });
  }

  document.getElementById("filtro-desc").addEventListener("input", renderInventario);
  document.getElementById("filtro-setor").addEventListener("input", renderInventario);
  document.getElementById("filtro-resp").addEventListener("input", renderInventario);

  // ================== MOVIMENTAÇÕES ====================

  function preencherSelectMov() {
    const sel = document.getElementById("mov-bem");
    sel.innerHTML = "";
    if (!bens.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Nenhum bem cadastrado";
      sel.appendChild(opt);
      return;
    }
    bens.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = `${b.id} - ${b.descricao}`;
      sel.appendChild(opt);
    });
  }

  document.getElementById("btn-registrar-mov").addEventListener("click", async () => {
    const idBem = document.getElementById("mov-bem").value;
    if (!idBem) {
      alert("Selecione um bem.");
      return;
    }
    const hoje = new Date().toISOString().slice(0,10);
    const dataMov = document.getElementById("mov-data").value || hoje;

    const data = {
      dataMov,
      idBem: Number(idBem),
      tipoMov: document.getElementById("mov-tipo").value.trim(),
      setorOrigem: document.getElementById("mov-setor-origem").value.trim(),
      setorDestino: document.getElementById("mov-setor-destino").value.trim(),
      respOrigem: document.getElementById("mov-resp-origem").value.trim(),
      respDestino: document.getElementById("mov-resp-destino").value.trim(),
      valor: document.getElementById("mov-valor").value,
      usuario: usuarioAtual ? usuarioAtual.email : "",
      descricao: document.getElementById("mov-desc").value.trim()
    };

    try {
      await supaInsert("movimentacoes", data);
      alert("Movimentação registrada.");
      document.getElementById("mov-desc").value = "";
      document.getElementById("mov-tipo").value = "";
      document.getElementById("mov-setor-origem").value = "";
      document.getElementById("mov-setor-destino").value = "";
      document.getElementById("mov-resp-origem").value = "";
      document.getElementById("mov-resp-destino").value = "";
      document.getElementById("mov-valor").value = "";
      await carregarTudo();
    } catch (err) {
      console.error(err);
      alert("Erro ao registrar movimentação no Supabase.");
    }
  });

  function renderTabelaMov() {
    const tbody = document.querySelector("#tabela-mov tbody");
    tbody.innerHTML = "";
    movimentacoes.slice().reverse().forEach(m => {
      const bem = bens.find(b => String(b.id) === String(m.idBem));
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.dataMov || ""}</td>
        <td>${m.idMov || ""}</td>
        <td>${bem ? bem.descricao : m.idBem}</td>
        <td>${m.tipoMov || ""}</td>
        <td>${m.setorOrigem || ""}</td>
        <td>${m.setorDestino || ""}</td>
        <td>${m.respOrigem || ""}</td>
        <td>${m.respDestino || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ================== MODAL DETALHES + TERMO ===========
  const modal = document.getElementById("modal-detalhes");
  const detBody = document.getElementById("det-body");
  const detTitulo = document.getElementById("det-titulo");
  const tabelaHist = document.querySelector("#tabela-hist tbody");

  function abrirModalDetalhes(idBem) {
    const bem = bens.find(b => String(b.id) === String(idBem));
    if (!bem) return;
    bemModalAtual = bem;
    detTitulo.textContent = `${bem.id || ""} - ${bem.descricao || ""}`;

    const statusClass = bem.situacao === "Baixado" ? "status-baixado" : "status-ativo";

    detBody.innerHTML = `
      <div class="small" style="margin-bottom:8px;">
        <span class="tag ${statusClass}">${bem.situacao || "Ativo"}</span>
        ${bem.tag ? `<span class="tag">Tag: ${bem.tag}</span>` : ""}
        ${bem.categoria ? `<span class="tag">Categoria: ${bem.categoria}</span>` : ""}
      </div>
      <div class="grid">
        <div class="field">
          <label>Setor</label>
          <div>${bem.setor || "-"}</div>
        </div>
        <div class="field">
          <label>Localização</label>
          <div>${bem.localizacao || "-"}</div>
        </div>
        <div class="field">
          <label>Responsável atual</label>
          <div>${bem.responsavel || "-"}</div>
        </div>
        <div class="field">
          <label>Nº de série</label>
          <div>${bem.numSerie || "-"}</div>
        </div>
        <div class="field">
          <label>Data de aquisição</label>
          <div>${bem.dataAquisicao || "-"}</div>
        </div>
        <div class="field">
          <label>Data início de uso</label>
          <div>${bem.dataInicioUso || "-"}</div>
        </div>
        <div class="field">
          <label>Vida útil (meses)</label>
          <div>${bem.vidaUtilMeses || "-"}</div>
        </div>
        <div class="field">
          <label>Método de depreciação</label>
          <div>${bem.metodoDepreciacao || "-"}</div>
        </div>
        <div class="field" style="grid-column:1/-1;">
          <label>Observações</label>
          <div>${bem.obs || "-"}</div>
        </div>
      </div>
    `;

    const hist = movimentacoes.filter(m => String(m.idBem) === String(idBem));
    tabelaHist.innerHTML = "";
    if (!hist.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7">Nenhuma movimentação registrada para este bem.</td>`;
      tabelaHist.appendChild(tr);
    } else {
      hist.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.dataMov || ""}</td>
          <td>${m.tipoMov || ""}</td>
          <td>${m.setorOrigem || ""}</td>
          <td>${m.setorDestino || ""}</td>
          <td>${m.respOrigem || ""}</td>
          <td>${m.respDestino || ""}</td>
          <td>${m.descricao || ""}</td>
        `;
        tabelaHist.appendChild(tr);
      });
    }

    modal.classList.add("active");
  }

  function fecharModal() {
    modal.classList.remove("active");
    bemModalAtual = null;
  }

  document.getElementById("btn-termo").addEventListener("click", () => {
    if (!bemModalAtual) return;
    gerarTermoResponsabilidade(bemModalAtual);
  });

  function gerarTermoResponsabilidade(bem) {
    const dataHoje = new Date();
    const dataStr = dataHoje.toLocaleDateString("pt-BR");
    const responsavel = bem.responsavel || "___________________________";

    const html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Termo de Responsabilidade - ${bem.descricao || ""}</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; }
  h1 { text-align: center; font-size: 20px; margin-bottom: 4px; }
  h2 { text-align: center; font-size: 16px; margin-top:0; margin-bottom:24px; color:#555;}
  .empresa { text-align:center; font-weight:bold; margin-bottom:24px; }
  .secao { margin-bottom:16px; }
  .label { font-weight:bold; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  td { padding:6px; border:1px solid #ccc; font-size:13px; }
  .assinatura { margin-top:40px; text-align:center; }
  .linha { margin-top:40px; border-top:1px solid #000; width:260px; margin-left:auto; margin-right:auto; }
  .small { font-size:12px; color:#555; }
</style>
</head>
<body>
  <div class="empresa">COMEBOM DISTRIBUIDORA</div>
  <h1>TERMO DE RESPONSABILIDADE POR BEM PATRIMONIAL</h1>
  <h2>${bem.descricao || ""}</h2>

  <div class="secao">
    Eu, <span class="label">${responsavel}</span>, declaro receber da <span class="label">COMEBOM DISTRIBUIDORA</span> o bem abaixo descrito, comprometendo-me a zelar por sua integridade, conservação e utilização adequada, devolvendo-o em perfeitas condições ou comunicando imediatamente qualquer ocorrência relevante.
  </div>

  <div class="secao">
    <div class="label">Dados do bem:</div>
    <table>
      <tr><td class="label" style="width:180px;">ID / Patrimônio</td><td>${bem.id || "-"}</td></tr>
      <tr><td class="label">Descrição</td><td>${bem.descricao || "-"}</td></tr>
      <tr><td class="label">Categoria</td><td>${bem.categoria || "-"}</td></tr>
      <tr><td class="label">Nº de série</td><td>${bem.numSerie || "-"}</td></tr>
      <tr><td class="label">Tag / Etiqueta</td><td>${bem.tag || "-"}</td></tr>
      <tr><td class="label">Setor / Local de uso</td><td>${bem.setor || "-"} - ${bem.localizacao || ""}</td></tr>
    </table>
  </div>

  <div class="secao small">
    Declaro estar ciente de que este bem continua sendo propriedade da empresa e que sua utilização é exclusiva para fins profissionais, sendo vedada a transferência a terceiros sem autorização.
  </div>

  <div class="assinatura">
    <div>${bem.localizacao || "Cidade"}, ${dataStr}</div>
    <div class="linha"></div>
    <div>${responsavel}</div>
  </div>
</body>
</html>
`;
    const w = window.open("", "_blank");
    w.document.write(html);
    w.document.close();
    w.focus();
    setTimeout(() => { try { w.print(); } catch (e) {} }, 300);
  }

  // ================== AUTO LOGIN =======================
  window.addEventListener("load", () => {
    try {
      const stored = localStorage.getItem("usuarioPatrimonio");
      if (stored) {
        usuarioAtual = JSON.parse(stored);
        iniciarApp();
      }
    } catch (e) {
      console.warn("Não foi possível restaurar o usuário logado.");
    }
  });
</script>

</body>
</html>



